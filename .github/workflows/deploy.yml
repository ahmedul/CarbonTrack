name: Deploy CarbonTrack to Production

on:
  pull_request:
    types: [closed]
    branches: [ main, production ]
    paths:
      - 'backend/**'
      - 'infra/**'
      - '.github/workflows/deploy.yml'
  push:
    branches: [ main, production ]
  workflow_dispatch:  # Manual deployment trigger
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      confirm:
        description: 'Type "DEPLOY" to confirm'
        required: true

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.10'

jobs:
  test:
    runs-on: ubuntu-latest
    # Run on push, merged PR, or manual dispatch
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install moto[cognitoidp] pytest-mock
        
    - name: Run backend tests
      run: |
        cd backend
        python -m pytest tests/ -v
      env:
        AWS_ACCESS_KEY_ID: fake-test-key-id
        AWS_SECRET_ACCESS_KEY: fake-test-secret-key
        AWS_DEFAULT_REGION: us-east-1
        COGNITO_USER_POOL_ID: fake-pool-id
        COGNITO_CLIENT_ID: fake-client-id
        TESTING: true
        
    - name: Test carbon calculations
      run: |
        cd backend
        python test_carbon_calculator.py

  build-frontend:
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.result == 'success'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create production build
      run: |
        mkdir -p dist
        cp -r frontend/* dist/
        
    - name: Optimize production files
      run: |
        # Install optimization tools
        npm install -g clean-css-cli html-minifier terser
        
        # Minify CSS (inline styles in HTML)
        html-minifier --collapse-whitespace --remove-comments --minify-css --minify-js \
          -o dist/index.html dist/index.html
          
        # Optimize any separate CSS files if they exist
        find dist -name "*.css" -exec cleancss -o {} {} \;
        
        # Minify JavaScript files if they exist
        find dist -name "*.js" -exec terser {} -o {} \;
        
    - name: Configure production API URLs
      run: |
        # Resolve API URL from Actions Variable first, then Secret fallback
        API_URL="${{ vars.PRODUCTION_API_URL }}"
        if [ -z "$API_URL" ]; then
          API_URL="${{ secrets.PRODUCTION_API_URL }}"
        fi

        # Inject window.API_BASE_URL into index.html if provided
        if [ -n "$API_URL" ]; then
          echo "Injecting API base URL into index.html: $API_URL"
          sed -i "s|</head>|<script>window.API_BASE_URL=\"$API_URL\";<\/script></head>|" dist/index.html || true
        else
          echo "No PRODUCTION_API_URL provided via Actions Variable or Secret; leaving default runtime behavior."
        fi

        # Cache-bust app-full.js so browsers fetch the fresh build
        sed -i 's|app-full.js|app-full.js?v=${{ github.sha }}|g' dist/index.html
        
    - name: Upload frontend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: dist/

  build-backend:
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.result == 'success'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Package backend for Lambda
      run: |
        cd backend
        
        # Create deployment package
        mkdir -p ../lambda-package
        
        # Copy application code
        cp -r app ../lambda-package/
        cp requirements.txt ../lambda-package/
        
        # Install dependencies
        pip install -r requirements.txt -t ../lambda-package/
        
        # Create Lambda handler
        cat > ../lambda-package/lambda_function.py << 'EOF'
        import json
        from mangum import Mangum
        from app.main import app
        
        # Mangum adapter for AWS Lambda
        handler = Mangum(app)
        
        def lambda_handler(event, context):
            return handler(event, context)
        EOF
        
        # Create requirements for Lambda
        echo "mangum==0.17.0" >> ../lambda-package/requirements.txt
        
    - name: Install Lambda dependencies
      run: |
        cd lambda-package
        pip install -r requirements.txt -t .
        
    - name: Create deployment package
      run: |
        cd lambda-package
        zip -r ../carbon-track-backend.zip .
        
    - name: Upload backend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-lambda
        path: carbon-track-backend.zip

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend]
    if: |
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/heads/main') ||
      startsWith(github.ref, 'refs/heads/production') ||
      (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'production'))
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Deploy infrastructure with CloudFormation
      run: |
        aws cloudformation deploy \
          --template-file infra/backend-template.yaml \
          --stack-name carbontrack-backend \
          --parameter-overrides \
            Environment=production \
          --capabilities CAPABILITY_NAMED_IAM

  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: needs.deploy-infrastructure.result == 'success'
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-lambda
        
    - name: Deploy to Lambda
      run: |
        aws lambda update-function-code \
          --function-name carbontrack-api-production \
          --zip-file fileb://carbon-track-backend.zip

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: needs.deploy-infrastructure.result == 'success'
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: dist/
        
    - name: Deploy to S3
      run: |
        aws s3 sync dist/ s3://carbontrack-frontend-production \
          --delete \
          --cache-control "max-age=31536000" \
          --exclude "*.html"
          
        # HTML files with shorter cache for updates
        aws s3 sync dist/ s3://carbontrack-frontend-production \
          --cache-control "max-age=0, no-cache, no-store, must-revalidate" \
          --include "*.html"
          
    - name: Display frontend URL
      run: |
        echo "üåê Frontend deployed successfully!"
        echo "üìç URL: http://carbontrack-frontend-production.s3-website-us-east-1.amazonaws.com"

  notify:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
          echo "üéâ CarbonTrack MVP deployment successful!"
          echo "üåç Frontend URL: http://carbontrack-frontend-production.s3-website-us-east-1.amazonaws.com"
          echo "üì¶ S3 Bucket: carbontrack-frontend-production"
          echo "ÔøΩÔ∏è DynamoDB Tables: carbontrack-users-production, carbontrack-emissions-production"
          echo ""
          echo "‚úÖ Infrastructure: S3 + DynamoDB ready"
          echo "‚è≥ Backend API: Coming soon (Lambda to be added)"
        else
          echo "‚ùå Deployment failed. Check the logs above for details."
          exit 1
        fi